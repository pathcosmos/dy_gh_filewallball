apiVersion: batch/v1
kind: CronJob
metadata:
  name: filewallball-backup-cronjob
  namespace: filewallball
  labels:
    app: filewallball-backup
spec:
  schedule: "0 2 * * *"  # ë§¤ì¼ ì˜¤ì „ 2ì‹œ
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: backup-job
            image: bitnami/kubectl:latest
            command:
            - /bin/bash
            - -c
            - |
              # MariaDB Pod ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
              MARIA_POD=$(kubectl get pods -n filewallball -l app=mariadb -o jsonpath='{.items[0].metadata.name}')

              if [ -z "$MARIA_POD" ]; then
                echo "âŒ MariaDB Podë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                exit 1
              fi

              echo "ğŸ“¦ MariaDB Pod: $MARIA_POD"

              # ë°±ì—… ë””ë ‰í† ë¦¬ í™•ì¸
              kubectl exec -n filewallball $MARIA_POD -- mkdir -p /backup

              # ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì‹¤í–‰
              DATE_FORMAT=$(date +"%Y%m%d_%H%M%S")
              BACKUP_FILE="filewallball_backup_${DATE_FORMAT}.sql"
              COMPRESSED_FILE="${BACKUP_FILE}.gz"

              echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì‹¤í–‰ ì¤‘..."
              kubectl exec -n filewallball $MARIA_POD -- bash -c "
              mysqldump -u root -pfilewallball2024 \
                  --single-transaction \
                  --routines \
                  --triggers \
                  --events \
                  --hex-blob \
                  --add-drop-database \
                  --add-drop-table \
                  --add-drop-trigger \
                  --add-drop-event \
                  --add-drop-procedure \
                  --add-drop-function \
                  --comments \
                  --complete-insert \
                  --extended-insert \
                  --lock-tables=false \
                  --set-charset \
                  --default-character-set=utf8mb4 \
                  filewallball_db > /backup/$BACKUP_FILE
              "

              # ë°±ì—… íŒŒì¼ ì••ì¶•
              echo "ğŸ—œï¸ ë°±ì—… íŒŒì¼ ì••ì¶• ì¤‘..."
              kubectl exec -n filewallball $MARIA_POD -- gzip /backup/$BACKUP_FILE

              # ë°±ì—… íŒŒì¼ ë¬´ê²°ì„± ê²€ì¦
              echo "ğŸ” ë°±ì—… íŒŒì¼ ë¬´ê²°ì„± ê²€ì¦ ì¤‘..."
              kubectl exec -n filewallball $MARIA_POD -- gzip -t /backup/$COMPRESSED_FILE

              # ì˜¤ë˜ëœ ë°±ì—… íŒŒì¼ ì •ë¦¬ (7ì¼)
              echo "ğŸ§¹ ì˜¤ë˜ëœ ë°±ì—… íŒŒì¼ ì •ë¦¬ ì¤‘..."
              kubectl exec -n filewallball $MARIA_POD -- bash -c "
              find /backup -name 'filewallball_backup_*.sql.gz' -mtime +7 -delete
              "

              # ë°±ì—… ì™„ë£Œ
              echo "âœ… FileWallBall Database Backup ì™„ë£Œ!"
              echo "ğŸ“ ë°±ì—… íŒŒì¼: /backup/$COMPRESSED_FILE"
            env:
            - name: KUBECONFIG
              value: "/.kube/config"
          serviceAccountName: filewallball-backup-sa
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: filewallball-backup-pvc
